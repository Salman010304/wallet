<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>School Finance Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    padding: {
                        'safe-bottom': 'env(safe-area-inset-bottom)',
                    }
                }
            }
        }
    </script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; overscroll-behavior-y: none; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar for Desktop */
        @media (min-width: 768px) {
            ::-webkit-scrollbar { width: 6px; }
            ::-webkit-scrollbar-track { background: transparent; }
            ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
            ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .filter-card { transition: all 0.2s ease; cursor: pointer; }
        .filter-card:active { transform: scale(0.95); }
        .filter-card.active { border: 2px solid #4f46e5; background-color: #e0e7ff; }
        .dark .filter-card.active { background-color: #312e81; border-color: #6366f1; }

        /* Loan Detail Animation */
        .loan-details { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .loan-details.open { max-height: 500px; }
        
        /* Mobile Specifics */
        .mobile-container { padding-bottom: calc(80px + env(safe-area-inset-bottom)); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 transition-colors duration-300 dark:bg-slate-900 dark:text-slate-100">
    
    <div id="root">
        <div style="display:flex; justify-content:center; align-items:center; height:100vh; color:#666;">Loading Application...</div>
    </div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, deleteDoc, doc, updateDoc, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const { useState, useEffect, useMemo } = React;

        // --- ICONS (Mapped to SVG) ---
        const Icons = {
            PieChart: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
            GraduationCap: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>,
            Plus: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Building2: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>,
            Cloud: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19h11Z"/><path d="M15 13.5c0-2.21-1.79-4-4-4s-4 1.79-4 4"/><path d="M20 10c0-4.418-3.582-8-8-8s-8 3.582-8 8"/><path d="M20 10h.01"/><path d="M4 10h.01"/></svg>,
            Sun: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Moon: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            Banknote: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></svg>,
            CreditCard: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>,
            AlertTriangle: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
            ArrowRight: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            Pencil: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            Trash2: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            MessageCircle: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>,
            Download: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Calendar: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            Filter: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            CheckCircle: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            MessageSquare: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            Share: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></svg>,
            Upload: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            FileSpreadsheet: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>,
            TrendingUp: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
            TrendingDown: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 17 13.5 8.5 8.5 13.5 2 7"/><polyline points="16 17 22 17 22 11"/></svg>,
            Send: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            ChevronDown: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>,
            ChevronUp: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"/></svg>,
            Tool: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
            History: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" /></svg>,
            X: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Wallet: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 7h-7a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2v-9a2 2 0 0 0-2-2Z"/><path d="M16 11h.01"/></svg>,
            Home: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            Refresh: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>,
            User: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            ArrowLeftRight: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 3 4 7l4 4"/><path d="M4 7h16"/><path d="m16 21 4-4-4-4"/><path d="M20 17H4"/></svg>,
        };

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDdrgAesHPCVtm7rdaKmzNrlVqDDKtkjd8",
            authDomain: "calcwallet.firebaseapp.com",
            projectId: "calcwallet",
            storageBucket: "calcwallet.firebasestorage.app",
            messagingSenderId: "854785212440",
            appId: "1:854785212440:web:803667e23f4e1755a2c36d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Constants ---
        const ACCOUNTS = ['Cash', 'HDFC Bank', 'SBI Bank', 'HDFC Credit', 'AU Credit'];
        const MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const STANDARDS = ['Nursery', 'Jr.KG', 'Sr.KG', '1st', '2nd', '3rd', '4th', '5th', '6th', '7th', '8th', '9th', '10th', '11th', '12th', 'College', 'Other'];
        const MEDIUMS = ['English', 'Gujarati'];
        const BOARDS = ['GSEB', 'CBSE', 'ICSE', 'IB', 'Other'];

        const DEFAULT_CATEGORIES = [
            { name: 'Rent', icon: 'ðŸ ' },
            { name: 'Electricity', icon: 'âš¡' },
            { name: 'Internet', icon: 'ðŸŒ' },
            { name: 'Snacks/Tea', icon: 'â˜•' },
            { name: 'Stationery', icon: 'âœï¸' },
            { name: 'Travelling', icon: 'ðŸš²' },
            { name: 'Routine Exp', icon: 'ðŸ”„' },
            { name: 'Family Exp', icon: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§' },
            { name: 'Loan/EMI', icon: 'ðŸ¦' },
            { name: 'Credit Card Bill', icon: 'ðŸ’³' }
        ];

        const DEFAULT_MSG = "àª¸àª²àª¾àª®/àª¨àª®àª¸à«àª¤à«‡ {parent},\n\nàª¨à«àª°àª¾àª¨à«€ àª•à«‹àªšàª¿àª‚àª— àª•à«àª²àª¾àª¸à«€àª¸ àª¤àª°àª«àª¥à«€ àª°àª¿àª®àª¾àª‡àª¨à«àª¡àª°:\n\nàªµàª¿àª¦à«àª¯àª¾àª°à«àª¥à«€àª¨à«àª‚ àª¨àª¾àª®: {name}\nàª¬àª¾àª•à«€ àª«à«€: â‚¹{amount}\nàª¬àª¾àª•à«€ àª®àª¹àª¿àª¨àª¾: {months}\n\nàª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àª«à«€ àªœàª®àª¾ àª•àª°àª¾àªµàªµàª¾ àªµàª¿àª¨àª‚àª¤à«€.\nàª†àª­àª¾àª°.";

        // --- Helper Components ---
        const PaymentIcon = ({ method }) => {
            if (!method) return <Icons.Banknote className="w-4 h-4 text-slate-500" />;
            const m = method.toLowerCase();
            if (m.includes('credit') || m.includes('cc')) return <Icons.CreditCard className="w-4 h-4 text-indigo-500" />;
            if (m.includes('bank') || m.includes('sbi') || m.includes('hdfc')) return <Icons.Building2 className="w-4 h-4 text-blue-500" />;
            return <Icons.Banknote className="w-4 h-4 text-emerald-500" />;
        };

        const DonutChart = ({ income, expense, onSliceClick }) => {
            const total = income + expense;
            if (total === 0) return <div className="text-center text-slate-400 text-xs py-8">No Data</div>;
            const radius = 40;
            const circumference = 2 * Math.PI * radius;
            const incomeDash = ((income / total) * 100 / 100) * circumference;
            return (
                <div className="relative w-48 h-48 mx-auto flex items-center justify-center">
                    <svg width="100%" height="100%" viewBox="0 0 100 100" className="transform -rotate-90">
                        <circle cx="50" cy="50" r={radius} fill="transparent" stroke="#fca5a5" strokeWidth="12" strokeDasharray={`${circumference} ${circumference}`} className="cursor-pointer hover:opacity-90 transition-all" onClick={() => onSliceClick('expense')} />
                        <circle cx="50" cy="50" r={radius} fill="transparent" stroke="#6ee7b7" strokeWidth="12" strokeDasharray={`${incomeDash} ${circumference}`} className="cursor-pointer hover:opacity-90 transition-all" onClick={() => onSliceClick('income')} />
                    </svg>
                    <div className="absolute text-center pointer-events-none">
                        <p className="text-xs text-slate-400">Total</p>
                        <p className="font-bold text-slate-800 dark:text-white text-lg">â‚¹{total.toLocaleString()}</p>
                    </div>
                </div>
            );
        };

        const CategoryBarChart = ({ data, color, onCategoryClick }) => {
            if (data.length === 0) return <div className="text-center text-slate-400 text-xs">No Data</div>;
            const maxVal = Math.max(...data.map(d => d.value));
            return (
                <div className="space-y-3 mt-4">
                    {data.map(item => (
                        <div key={item.name} onClick={() => onCategoryClick && onCategoryClick(item.name)} className="cursor-pointer hover:opacity-80 transition-opacity">
                            <div className="flex justify-between text-xs mb-1">
                                <span className="font-medium text-slate-600 dark:text-slate-300">{item.name}</span>
                                <span className="font-bold text-slate-800 dark:text-white">â‚¹{item.value.toLocaleString()}</span>
                            </div>
                            <div className="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-2.5 overflow-hidden">
                                <div className={`h-2.5 rounded-full ${color}`} style={{ width: `${(item.value / maxVal) * 100}%` }}></div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        // --- Main App ---
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [transactions, setTransactions] = useState([]);
            const [students, setStudents] = useState([]);
            const [loans, setLoans] = useState([]);
            const [openingBalances, setOpeningBalances] = useState({});
            
            const [activeTab, setActiveTab] = useState('dashboard');
            const [mode, setMode] = useState('cloud'); 
            const [darkMode, setDarkMode] = useState(false);
            const [showChartModal, setShowChartModal] = useState(false);
            const [viewingStudent, setViewingStudent] = useState(null);
            const [editingTx, setEditingTx] = useState(null);
            const [editingStudent, setEditingStudent] = useState(null);
            const [showAllTransactions, setShowAllTransactions] = useState(false);
            const [dateFilter, setDateFilter] = useState({ start: '', end: '' });
            const [categoryFilter, setCategoryFilter] = useState(null);
            const [chartView, setChartView] = useState('overview');
            const [studentFilterType, setStudentFilterType] = useState('all');
            const [accountFilter, setAccountFilter] = useState('All');
            
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [authError, setAuthError] = useState('');
            
            const [expenseCategories, setExpenseCategories] = useState(DEFAULT_CATEGORIES);
            const [isEditMode, setIsEditMode] = useState(false);
            const [amount, setAmount] = useState('');
            const [description, setDescription] = useState('');
            const [studentName, setStudentName] = useState('');
            const [studentParent, setStudentParent] = useState('');
            const [studentJoinDate, setStudentJoinDate] = useState('');
            const [studentLeaveDate, setStudentLeaveDate] = useState('');
            const [studentFee, setStudentFee] = useState('');
            const [studentStd, setStudentStd] = useState(STANDARDS[0]);
            const [studentMedium, setStudentMedium] = useState(MEDIUMS[0]);
            const [studentSchool, setStudentSchool] = useState(''); 
            const [studentBoard, setStudentBoard] = useState(BOARDS[0]); 
            const [studentPhone, setStudentPhone] = useState(''); 
            const [feeMonth, setFeeMonth] = useState(''); 
            const [type, setType] = useState('expense');
            const [category, setCategory] = useState('Food');
            const [paymentMethod, setPaymentMethod] = useState('Cash');
            const [transferTo, setTransferTo] = useState(ACCOUNTS[1]); 
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [reminderMsg, setReminderMsg] = useState(DEFAULT_MSG);
            
            // New State for Multi-Month Selection
            const [selectedMonths, setSelectedMonths] = useState([]);

            const [showLoanForm, setShowLoanForm] = useState(false);
            const [newLoan, setNewLoan] = useState({ name: '', total: '' });
            const [selectedLoanId, setSelectedLoanId] = useState('');
            const [selectedCreditCard, setSelectedCreditCard] = useState('');
            const [showLoanDetails, setShowLoanDetails] = useState(false);
            const [apiKey, setApiKey] = useState('');
            const [projectId, setProjectId] = useState('');

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                });
                
                if (localStorage.getItem('wallet_dark_mode') === 'true') {
                    setDarkMode(true);
                    document.documentElement.classList.add('dark');
                }
                const storedCats = localStorage.getItem('wallet_categories');
                if(storedCats) setExpenseCategories(JSON.parse(storedCats));

                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) {
                    if(mode === 'local') loadLocalData();
                    return;
                }

                if (mode === 'cloud') {
                    setLoading(true);
                    const txQuery = query(collection(db, 'users', user.uid, 'transactions'));
                    const unsubTx = onSnapshot(txQuery, (snap) => {
                        const data = snap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                        data.sort((a, b) => new Date(b.date) - new Date(a.date));
                        setTransactions(data);
                        setLoading(false);
                    });

                    const stQuery = query(collection(db, 'users', user.uid, 'students'));
                    const unsubSt = onSnapshot(stQuery, (snap) => setStudents(snap.docs.map(doc => ({ ...doc.data(), id: doc.id }))));

                    const lnQuery = query(collection(db, 'users', user.uid, 'loans'));
                    const unsubLn = onSnapshot(lnQuery, (snap) => setLoans(snap.docs.map(doc => ({ ...doc.data(), id: doc.id }))));
                    
                    const balQuery = doc(db, 'users', user.uid, 'settings', 'opening_balances');
                    const unsubBal = onSnapshot(balQuery, (snap) => {
                        if(snap.exists()) setOpeningBalances(snap.data());
                    });

                    return () => { unsubTx(); unsubSt(); unsubLn(); unsubBal(); };
                } else {
                    loadLocalData();
                    setLoading(false);
                }
            }, [user, mode]);

            const loadLocalData = () => {
                try {
                    const savedTx = localStorage.getItem('my_wallet_data');
                    if (savedTx) setTransactions(JSON.parse(savedTx));
                    const savedSt = localStorage.getItem('my_wallet_students');
                    if (savedSt) setStudents(JSON.parse(savedSt).filter(s => s && s.name));
                    const savedLoans = localStorage.getItem('my_wallet_loans');
                    if (savedLoans) setLoans(JSON.parse(savedLoans));
                    const savedOB = localStorage.getItem('my_wallet_opening_balances');
                    if (savedOB) setOpeningBalances(JSON.parse(savedOB));
                    const savedMsg = localStorage.getItem('my_wallet_msg');
                    if (savedMsg) setReminderMsg(savedMsg);
                } catch (e) { console.error("Local load error", e); }
            };

            const saveLocalData = (txData, stData, loanData, obData) => {
                if (mode !== 'local') return;
                if(txData) localStorage.setItem('my_wallet_data', JSON.stringify(txData));
                if(stData) localStorage.setItem('my_wallet_students', JSON.stringify(stData));
                if(loanData) localStorage.setItem('my_wallet_loans', JSON.stringify(loanData));
                if(obData) localStorage.setItem('my_wallet_opening_balances', JSON.stringify(obData));
            };

            const toggleDarkMode = () => {
                const newVal = !darkMode;
                setDarkMode(newVal);
                if (newVal) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                localStorage.setItem('wallet_dark_mode', newVal);
            };

            const getStudentFinancials = (student) => {
                try {
                    if (!student || !student.joinDate) return { paid: 0, pending: 0, status: 'New', missingMonths: [] };
                    const join = new Date(student.joinDate);
                    const today = new Date();
                    let endDate = today;
                    if (student.leaveDate) { 
                        const leave = new Date(student.leaveDate); 
                        if (!isNaN(leave.getTime()) && leave < today) endDate = leave; 
                    }
                    let expectedMonths = [];
                    let current = new Date(join);
                    current.setDate(1); 
                    
                    let totalExpected = 0;
                    
                    let safety = 0;
                    while (current <= endDate && safety < 60) {
                        const monthName = MONTHS[current.getMonth()];
                        expectedMonths.push(monthName);
                        
                        // --- PRO RATA CALCULATION INTEGRATED HERE ---
                        // Check if this is the student's joining month
                        const isJoinMonth = current.getMonth() === join.getMonth() && current.getFullYear() === join.getFullYear();
                        
                        if (isJoinMonth) {
                             const daysInMonth = new Date(current.getFullYear(), current.getMonth() + 1, 0).getDate();
                             const dayJoined = join.getDate();
                             const daysActive = daysInMonth - dayJoined + 1;
                             totalExpected += Math.round((student.monthlyFee / daysInMonth) * daysActive);
                        } else {
                             // Full fee for regular months
                             totalExpected += (student.monthlyFee || 0);
                        }
                        
                        current.setMonth(current.getMonth() + 1); 
                        safety++;
                    }
                    const paidTx = transactions.filter(t => t.studentName === student.name && t.category === 'Tuition Fees' && t.type === 'income');
                    const totalPaid = paidTx.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0); 
                    
                    const missingMonths = expectedMonths.filter(m => !paidTx.some(t => t.feeMonth && t.feeMonth.includes(m)));
                    
                    // Total Expected is now dynamically calculated above
                    const pending = totalExpected - totalPaid;
                    
                    let status = 'Paid';
                    if (student.leaveDate && pending <= 0) status = 'Left (Paid)'; 
                    else if (pending > (student.monthlyFee || 0)) status = 'Overdue'; 
                    else if (pending > 0) status = 'Due'; 
                    else if (pending < 0) status = 'Advance';
                    
                    return { paid: totalPaid, pending: pending > 0 ? pending : 0, missingMonths, status };
                } catch (error) { return { paid: 0, pending: 0, status: 'Error' }; }
            };

            const uniqueSchools = useMemo(() => { 
                if(!students) return [];
                return students.map(s => s.school).filter((v,i,a)=>v && a.indexOf(v)===i);
            }, [students]);

            const filteredTransactions = useMemo(() => {
                let filtered = transactions;
                if (dateFilter.start || dateFilter.end) {
                    filtered = filtered.filter(t => {
                        const tDate = new Date(t.date);
                        const start = dateFilter.start ? new Date(dateFilter.start) : new Date('2000-01-01');
                        const end = dateFilter.end ? new Date(dateFilter.end) : new Date('2099-12-31');
                        start.setHours(0,0,0,0);
                        end.setHours(23,59,59,999);
                        const checkDate = new Date(tDate);
                        checkDate.setHours(12,0,0,0);
                        return checkDate >= start && checkDate <= end;
                    });
                }
                if (categoryFilter) { filtered = filtered.filter(t => t.category === categoryFilter); }
                if (accountFilter && accountFilter !== 'All') {
                    filtered = filtered.filter(t => t.paymentMethod === accountFilter || t.transferTo === accountFilter);
                }
                return filtered;
            }, [transactions, dateFilter, categoryFilter, accountFilter]);

            // Alias for safe usage
            const safeFilteredTransactions = filteredTransactions;

            const summary = useMemo(() => {
                let income = 0, expense = 0;
                const balances = {};
                const incomeByCat = {};
                const expenseByCat = {};
                const cashGroup = [];
                const bankGroup = [];
                const creditGroup = [];
                
                ACCOUNTS.forEach(acc => balances[acc] = parseFloat(openingBalances[acc] || 0)); 
                
                transactions.forEach(t => { 
                    const amt = parseFloat(t.amount || 0); 
                    if (t.type === 'income') { 
                        income += amt; 
                        if (balances[t.paymentMethod] !== undefined) balances[t.paymentMethod] += amt; 
                        incomeByCat[t.category] = (incomeByCat[t.category] || 0) + amt; 
                    } else if (t.type === 'expense') { 
                        expense += amt; 
                        if (balances[t.paymentMethod] !== undefined) balances[t.paymentMethod] -= amt; 
                        expenseByCat[t.category] = (expenseByCat[t.category] || 0) + amt; 
                    } else if (t.type === 'transfer') { 
                        // Transfer Logic: Deduct from source (paymentMethod), Add to dest (transferTo)
                        if (balances[t.paymentMethod] !== undefined) balances[t.paymentMethod] -= amt; 
                        if (balances[t.transferTo] !== undefined) balances[t.transferTo] += amt; 
                    } 
                });

                Object.entries(balances).forEach(([name, amount]) => { 
                    if (name.toLowerCase().includes('credit')) creditGroup.push({name, amount}); 
                    else if (name.toLowerCase().includes('bank')) bankGroup.push({name, amount}); 
                    else cashGroup.push({name, amount}); 
                });

                let totalLiquidBalance = 0;
                ['Cash', 'HDFC Bank', 'SBI Bank'].forEach(acc => totalLiquidBalance += (balances[acc] || 0));

                const incomeData = Object.entries(incomeByCat).map(([name, value]) => ({ name, value }));
                const expenseData = Object.entries(expenseByCat).map(([name, value]) => ({ name, value }));
                let totalLoanPending = loans.reduce((sum, l) => sum + (l.total - l.paid), 0);
                
                return { income, expense, balance: totalLiquidBalance, accounts: balances, incomeData, expenseData, cashGroup, bankGroup, creditGroup, totalLoanPending };
            }, [transactions, openingBalances, loans]);

            const tStats = (() => {
                const totalStudents = students.length;
                const totalReceived = transactions.filter(t => t.category === 'Tuition Fees' && t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                const totalPending = students.reduce((sum, s) => sum + (getStudentFinancials(s).pending || 0), 0); 
                return { totalStudents, totalReceived, totalPending };
            })();

            const balanceColor = summary.balance >= 0 ? 'text-emerald-500' : 'text-rose-500';

            const handleLogin = async (e) => {
                e.preventDefault();
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setAuthError('Login failed: ' + err.message);
                }
            };

            const toggleMonth = (m) => {
                if (selectedMonths.includes(m)) {
                    setSelectedMonths(selectedMonths.filter(month => month !== m));
                } else {
                    setSelectedMonths([...selectedMonths, m]);
                }
            };

            const handleQuickExpenseClick = (categoryObj) => {
                if(isEditMode) {
                    // Rename / Icon Change
                    const newName = prompt("Rename category:", categoryObj.name);
                    if(newName === null) return;
                    const newIcon = prompt("Change icon (Emoji):", categoryObj.icon);
                    if(newIcon === null) return;
                    
                    if (newName) {
                         const updated = expenseCategories.map(c => c.name === categoryObj.name ? { ...c, name: newName, icon: newIcon || c.icon } : c);
                         setExpenseCategories(updated);
                         localStorage.setItem('wallet_categories', JSON.stringify(updated));
                    }
                    return;
                }
                
                // Normal Selection
                setType('expense');
                setCategory(categoryObj.name); 
                if (!editingTx && description === '') { setDescription(categoryObj.name); }
                if(!editingTx) { setAmount(''); }
            };

            const handleDeleteCategory = (catName) => {
                if(confirm(`Delete category "${catName}"?`)) {
                    const updated = expenseCategories.filter(c => c.name !== catName);
                    setExpenseCategories(updated);
                    localStorage.setItem('wallet_categories', JSON.stringify(updated));
                    if(updated.length === 0) setIsEditMode(false);
                }
            };

            const handleAddCategory = () => {
                const newCat = prompt("Enter new category name:");
                if(!newCat) return;
                const newIcon = prompt("Enter category icon (Emoji):", "âœ¨");
                const updated = [...expenseCategories, { name: newCat, icon: newIcon || 'âœ¨' }];
                setExpenseCategories(updated);
                localStorage.setItem('wallet_categories', JSON.stringify(updated));
            };

            const generatePDFReceipt = (transaction) => {
                try {
                    if (!window.jspdf || !window.jspdf.jsPDF) {
                        alert("PDF Tool is loading..."); return;
                    }
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // --- 1. Colors & Styles ---
                    const primaryColor = [67, 56, 202]; // Indigo 700
                    const lightGray = [241, 245, 249]; // Slate 100
                    const darkText = [30, 41, 59]; // Slate 800
                    
                    // --- 2. Header Section ---
                    doc.setFillColor(...primaryColor);
                    doc.rect(0, 0, 210, 50, 'F'); // Header bg
                    
                    // Institute Name
                    doc.setTextColor(255, 255, 255);
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(26);
                    doc.text("NURANI COACHING CLASSES", 105, 25, null, null, "center");
                    
                    // Tagline
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.text("Excellence in Education", 105, 35, null, null, "center");

                    // --- 3. Receipt Title & Meta ---
                    doc.setTextColor(...darkText);
                    doc.setFontSize(16);
                    doc.setFont("helvetica", "bold");
                    doc.text("FEE PAYMENT RECEIPT", 105, 65, null, null, "center");
                    
                    // --- NEW RECEIPT NUMBER LOGIC (NCC/YYYY/0001) ---
                    const txDate = new Date(transaction.date);
                    const year = txDate.getFullYear();
                    
                    // Filter for Tuition Fees in the SAME Calendar Year
                    const yearTransactions = transactions.filter(t => {
                        if (t.category !== 'Tuition Fees' || t.type !== 'income') return false;
                        const tDate = new Date(t.date);
                        return tDate.getFullYear() === year;
                    }).sort((a, b) => new Date(a.date) - new Date(b.date) || (a.createdAt || '').localeCompare(b.createdAt || ''));

                    // Find index (1-based) to ensure stable numbers
                    const index = yearTransactions.findIndex(t => t.id === transaction.id);
                    const count = index !== -1 ? index + 1 : yearTransactions.length + 1;
                    const serialNum = count.toString().padStart(4, '0');
                    
                    const receiptNo = `NCC/${year}/${serialNum}`;
                    const dateStr = txDate.toLocaleDateString('en-GB');
                    
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.text(`Receipt No: ${receiptNo}`, 190, 60, null, null, "right");
                    doc.text(`Date: ${dateStr}`, 190, 65, null, null, "right");

                    // --- 4. Student Details Section ---
                    const studentData = students.find(s => s.name === transaction.studentName) || {};
                    
                    doc.setFillColor(...lightGray);
                    doc.roundedRect(15, 75, 180, 35, 3, 3, 'F'); // Gray box
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 116, 139); // Slate 500
                    doc.text("STUDENT DETAILS", 20, 83);
                    
                    doc.setTextColor(...darkText);
                    doc.setFontSize(11);
                    doc.setFont("helvetica", "bold");
                    
                    // Name
                    doc.text("Name:", 20, 92);
                    doc.setFont("helvetica", "normal");
                    doc.text(transaction.studentName || "N/A", 50, 92);
                    
                    // Parent
                    doc.setFont("helvetica", "bold");
                    doc.text("Parent:", 110, 92);
                    doc.setFont("helvetica", "normal");
                    doc.text(studentData.parentName || "-", 135, 92);

                    // Row 2: Class & Course
                    doc.setFont("helvetica", "bold");
                    doc.text("Class:", 20, 102);
                    doc.setFont("helvetica", "normal");
                    const stdText = studentData.std ? `${studentData.std} (${studentData.medium || ''})` : "-";
                    doc.text(stdText, 50, 102);
                    
                    doc.setFont("helvetica", "bold");
                    doc.text("Board:", 110, 102);
                    doc.setFont("helvetica", "normal");
                    doc.text(studentData.board || "GSEB", 135, 102);

                    // --- 5. Payment Table ---
                    let y = 125;
                    
                    // Table Header
                    doc.setFillColor(...primaryColor);
                    doc.rect(15, y, 180, 10, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(9);
                    doc.text("DESCRIPTION", 25, y + 7);
                    doc.text("FEE MONTH", 90, y + 7);
                    doc.text("MODE", 140, y + 7);
                    doc.text("AMOUNT", 185, y + 7, null, null, "right");
                    
                    // Table Row
                    y += 18;
                    doc.setTextColor(...darkText);
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(10);
                    
                    const desc = transaction.category === 'Tuition Fees' ? 'Tuition Fee Payment' : transaction.description;
                    const month = transaction.feeMonth || "-";
                    
                    doc.text(desc.substring(0, 30), 25, y);
                    doc.text(month, 90, y);
                    doc.text(transaction.paymentMethod || "Cash", 140, y);
                    doc.text(`Rs. ${transaction.amount}/-`, 185, y, null, null, "right");
                    
                    // Line under row
                    doc.setDrawColor(226, 232, 240);
                    doc.line(15, y + 5, 195, y + 5);

                    // --- 6. Total Amount Highlight ---
                    y += 20;
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "bold");
                    doc.text("TOTAL PAID:", 140, y);
                    
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(16);
                    doc.text(`Rs. ${transaction.amount}`, 190, y, null, null, "right");

                    // --- 7. Footer & Signature ---
                    const footerY = 250;
                    
                    doc.setTextColor(...darkText);
                    doc.setFontSize(10);
                    
                    // Organization
                    doc.setFont("helvetica", "bold");
                    doc.text("For, Nurani Coaching Classes", 190, footerY - 20, null, null, "right");
                    
                    // Sd/-
                    doc.setFont("helvetica", "normal");
                    doc.text("Sd/-", 190, footerY - 10, null, null, "right");

                    // Name
                    doc.setFont("helvetica", "bold");
                    doc.text("Mohammad Salman", 190, footerY - 4, null, null, "right");

                    // Title
                    doc.setFontSize(9);
                    doc.setFont("helvetica", "normal");
                    doc.setTextColor(100, 116, 139); // Slate 500
                    doc.text("Authorized Signatory", 190, footerY + 1, null, null, "right");

                    // Thank You Message
                    doc.setFillColor(248, 250, 252);
                    doc.rect(0, 270, 210, 27, 'F');
                    doc.setTextColor(100, 116, 139);
                    doc.setFontSize(9);
                    doc.text("Thank you for choosing Nurani Coaching Classes.", 105, 280, null, null, "center");
                    doc.text("This is a computer-generated receipt.", 105, 285, null, null, "center");

                    // Use sanitized receipt no for filename (replace all slashes)
                    const safeReceiptNo = receiptNo.replace(/\//g, '-');
                    doc.save(`Receipt_${transaction.studentName}_${safeReceiptNo}.pdf`);
                } catch (e) { 
                    console.error(e);
                    alert("Error generating receipt. Please try again."); 
                }
            };

            const sendReminder = (student, pendingAmount, missingMonths) => {
                const monthsText = missingMonths && missingMonths.length > 0 ? missingMonths.join(", ") : "N/A";
                let msg = reminderMsg.replace('{parent}', student.parentName || 'Parent').replace('{name}', student.name).replace('{amount}', pendingAmount).replace('{months}', monthsText);
                let phone = student.phone ? student.phone.replace(/\D/g, '') : '';
                if (phone.length === 10) phone = '91' + phone;
                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
            };

            const sendReceiptWhatsApp = (tx, student) => {
                let phone = student.phone ? student.phone.replace(/\D/g, '') : '';
                if (phone.length === 10) phone = '91' + phone;
                const msg = `*Payment Receipt - Nurani Coaching Classes*\n\nStudent: ${student.name}\nParent: ${student.parentName || 'Parent'}\nAmount: â‚¹${tx.amount}\nMonth: ${tx.feeMonth || 'N/A'}\nDate: ${tx.date}\nMethod: ${tx.paymentMethod}\n\nThank you!`;
                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
            };

            const fixCorruptedDataInternal = () => {
                 if(confirm("Repair data?")) {
                     const savedSt = localStorage.getItem('my_wallet_students');
                     if(savedSt) {
                         const parsed = JSON.parse(savedSt);
                         const clean = Array.isArray(parsed) ? parsed.filter(s => s && s.name) : [];
                         localStorage.setItem('my_wallet_students', JSON.stringify(clean));
                         window.location.reload();
                     }
                 }
            };

            const scrollToForm = () => {
                const formElement = document.getElementById('student-form');
                if(formElement) formElement.scrollIntoView({ behavior: 'smooth' });
            };

            const handleFilteredExport = () => {
                let csvContent = "Date,Description,Type,Category,Amount,Account,Student Name,Fee Month\n";
                safeFilteredTransactions.forEach(t => {
                    const row = [
                        t.date,
                        `"${(t.description || '').replace(/"/g, '""')}"`,
                        t.type,
                        t.category,
                        t.amount,
                        t.paymentMethod,
                        t.studentName || "-",
                        t.feeMonth || "-"
                    ].join(",");
                    csvContent += row + "\n";
                });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `statement.csv`;
                link.click();
            };

            const calculateProRata = (fee, joinDate) => {
                if(!fee || !joinDate) return 0;
                const join = new Date(joinDate);
                const daysInMonth = new Date(join.getFullYear(), join.getMonth() + 1, 0).getDate();
                const dayJoined = join.getDate();
                const daysActive = daysInMonth - dayJoined + 1;
                return Math.round((fee / daysInMonth) * daysActive);
            };

            const handleTransactionSubmit = async (e) => {
                e.preventDefault();
                if (!amount) return;
                
                let isTuition = category === 'Tuition Fees' && type === 'income';
                let finalDesc = description;
                let finalType = type;
                let finalCategory = category;
                let finalTransferTo = type === 'transfer' ? transferTo : null;
                let finalFeeMonth = feeMonth;

                if (isTuition) {
                    // Logic for multi-month: Use selectedMonths if available, otherwise fallback to single feeMonth
                    const monthsString = selectedMonths.length > 0 ? selectedMonths.join(', ') : feeMonth;
                    finalFeeMonth = monthsString;
                    finalDesc = `Tuition: ${studentName} (${monthsString})`;
                }

                // Loan Payoff Logic
                if (category === 'Loan/EMI' && selectedLoanId && type === 'expense') {
                    const loan = loans.find(l => l.id === selectedLoanId);
                    if (loan) {
                        finalDesc = `EMI: ${loan.name}`;
                        const newPaid = (loan.paid || 0) + parseFloat(amount);
                        // Update Loan
                        if (mode === 'cloud') await updateDoc(doc(db, 'users', user.uid, 'loans', loan.id), { paid: newPaid });
                        else {
                            const u = loans.map(l => l.id === loan.id ? { ...l, paid: newPaid } : l);
                            setLoans(u); saveLocalData(null, null, u);
                        }
                    }
                }

                // Credit Card Bill Logic - Treated as TRANSFER
                if (category === 'Credit Card Bill' && selectedCreditCard && type === 'expense') {
                    finalType = 'transfer';
                    finalTransferTo = selectedCreditCard; // Destination is CC
                    finalCategory = 'Credit Card Bill';
                    finalDesc = `Bill Payment: ${selectedCreditCard}`;
                    // paymentMethod is already set (Source: e.g., Cash)
                }
                
                const txData = {
                    amount: parseFloat(amount), description: finalDesc, studentName: isTuition ? studentName : null,
                    feeMonth: isTuition ? finalFeeMonth : null, type: finalType, category: finalCategory, paymentMethod, transferTo: finalTransferTo,
                    date, dateStr: new Date(date).toLocaleDateString(), createdAt: new Date().toISOString()
                };

                if (mode === 'cloud') {
                    if (editingTx) await updateDoc(doc(db, 'users', user.uid, 'transactions', editingTx.id), txData);
                    else await addDoc(collection(db, 'users', user.uid, 'transactions'), txData);
                } else {
                    let newTxList = editingTx ? transactions.map(t => t.id === editingTx.id ? { ...t, ...txData, id: editingTx.id } : t) : [{ ...txData, id: Date.now().toString() }, ...transactions];
                    newTxList.sort((a,b) => new Date(b.date) - new Date(a.date));
                    setTransactions(newTxList);
                    saveLocalData(newTxList);
                }
                // Reset Form
                setEditingTx(null); setAmount(''); setDescription(''); setStudentName(''); setSelectedLoanId(''); setSelectedCreditCard(''); setSelectedMonths([]);
                if (!isTuition) setActiveTab('dashboard');
            };

            const handleStudentSubmit = async (e) => {
                e.preventDefault();
                const studentData = { 
                    name: studentName || '', 
                    parentName: studentParent || '', 
                    joinDate: studentJoinDate || '', 
                    leaveDate: studentLeaveDate || null, 
                    monthlyFee: parseFloat(studentFee) || 0, 
                    std: studentStd || STANDARDS[0], 
                    medium: studentMedium || MEDIUMS[0], 
                    school: studentSchool || '', 
                    board: studentBoard || BOARDS[0], 
                    phone: studentPhone || '', 
                    active: !studentLeaveDate 
                };

                if (mode === 'cloud') {
                    if (editingStudent) await updateDoc(doc(db, 'users', user.uid, 'students', editingStudent.id), studentData);
                    else await addDoc(collection(db, 'users', user.uid, 'students'), { ...studentData, createdAt: new Date().toISOString() });
                } else {
                    let newStudents = editingStudent ? students.map(s => s.id === editingStudent.id ? { ...s, ...studentData } : s) : [...students, { ...studentData, id: Date.now().toString() }];
                    setStudents(newStudents);
                    saveLocalData(null, newStudents);
                }
                setEditingStudent(null); setStudentName(''); setStudentParent(''); setStudentFee(''); setStudentJoinDate(''); setStudentLeaveDate(''); setStudentPhone(''); setStudentSchool(''); setStudentBoard('GSEB'); alert(editingStudent ? "Updated!" : "Added!");
            };

            const handleCancelStudentEdit = () => { setEditingStudent(null); setStudentName(''); setStudentParent(''); setStudentFee(''); setStudentJoinDate(''); setStudentLeaveDate(''); setStudentPhone(''); };

            const handleEditStudentFromModal = () => {
                if(!viewingStudent) return;
                const s = viewingStudent;
                setEditingStudent(s);
                setStudentName(s.name || '');
                setStudentParent(s.parentName || '');
                setStudentFee(s.monthlyFee || '');
                setStudentJoinDate(s.joinDate || '');
                setStudentLeaveDate(s.leaveDate || '');
                setStudentPhone(s.phone || '');
                setStudentStd(s.std || STANDARDS[0]);
                setStudentMedium(s.medium || MEDIUMS[0]);
                setStudentSchool(s.school || '');
                setStudentBoard(s.board || BOARDS[0]);
                
                setViewingStudent(null);
                scrollToForm();
            };

            const handleDelete = async (colName, id) => {
                if (!confirm("Delete?")) return;
                if (mode === 'cloud') await deleteDoc(doc(db, 'users', user.uid, colName, id));
                else {
                    if (colName === 'transactions') { const u = transactions.filter(t => t.id !== id); setTransactions(u); saveLocalData(u); }
                    else if (colName === 'students') { const u = students.filter(s => s.id !== id); setStudents(u); saveLocalData(null, u); }
                    else if (colName === 'loans') { const u = loans.filter(l => l.id !== id); setLoans(u); saveLocalData(null, null, u); }
                }
            };

            const handleAddLoan = async () => {
                if (!newLoan.name || !newLoan.total) return;
                const loanData = { name: newLoan.name, total: parseFloat(newLoan.total), paid: 0 };
                if (mode === 'cloud') await addDoc(collection(db, 'users', user.uid, 'loans'), loanData);
                else {
                    const u = [...loans, { ...loanData, id: Date.now().toString() }];
                    setLoans(u); saveLocalData(null, null, u);
                }
                setNewLoan({ name: '', total: '' }); setShowLoanForm(false);
            };

            const handleUpdateLoanBalance = async (id, val) => {
                const newPaid = parseFloat(val);
                if (isNaN(newPaid)) return;
                if (mode === 'cloud') await updateDoc(doc(db, 'users', user.uid, 'loans', id), { paid: newPaid });
                else {
                    const u = loans.map(l => l.id === id ? { ...l, paid: newPaid } : l);
                    setLoans(u); saveLocalData(null, null, u);
                }
            };

            const handleBackup = () => {
                const dataStr = JSON.stringify({transactions, students}, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `wallet_backup.json`;
                link.click();
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        let newTx = importedData.transactions || [];
                        let newSt = importedData.students || [];
                        if (confirm(`Import ${newTx.length} transactions and ${newSt.length} students?`)) {
                            if (mode === 'local') {
                                const mergedTx = [...transactions, ...newTx];
                                const mergedSt = [...students, ...newSt];
                                setTransactions(mergedTx); setStudents(mergedSt);
                                saveLocalData(mergedTx, mergedSt);
                            }
                            alert("Import successful!");
                        }
                    } catch(err) { alert("Error importing"); }
                };
                reader.readAsText(file);
            };

            const handleAccountFilter = (accName) => {
                setAccountFilter(accName);
                setActiveTab('history');
            };

            if (loading) return <div className="flex items-center justify-center h-screen bg-slate-50 dark:bg-slate-900"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>;

            if (mode === 'cloud' && !user) {
                return (
                    <div className="min-h-screen bg-slate-50 dark:bg-slate-900 flex items-center justify-center p-6 font-sans">
                        <div className="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-xl max-w-sm w-full border border-slate-200 dark:border-slate-700">
                            <div className="text-center mb-8">
                                <div className="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Cloud className="w-8 h-8" /></div>
                                <h2 className="text-2xl font-bold text-slate-900 dark:text-white mb-1">Cloud Login</h2>
                                <p className="text-sm text-slate-500 dark:text-slate-400">Access your school finance data</p>
                            </div>
                            {authError && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4">{authError}</div>}
                            <form onSubmit={handleLogin} className="space-y-4">
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full p-3 border rounded-lg dark:bg-slate-700 dark:text-white" required placeholder="Email" />
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-3 border rounded-lg dark:bg-slate-700 dark:text-white" required placeholder="Password" />
                                <button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold">Login</button>
                            </form>
                            <button onClick={() => setMode('local')} className="w-full mt-6 text-slate-400 text-sm">Switch to Offline Mode</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className={`min-h-screen bg-slate-50 dark:bg-slate-900 font-sans text-slate-900 dark:text-slate-100 ${darkMode ? 'dark' : ''}`}>
                    {/* PC/Desktop Layout */}
                    <div className="hidden md:flex flex-col md:fixed md:left-0 md:top-0 md:h-screen md:w-64 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 p-6 z-20">
                        <h1 className="text-2xl font-bold text-indigo-600 dark:text-indigo-400 mb-8">My Wallet Pro</h1>
                        <nav className="space-y-2 flex-1">
                            {['dashboard', 'students', 'history', 'add', 'settings'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition capitalize ${activeTab === tab ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600' : 'text-slate-500'}`}>
                                    {tab === 'dashboard' && <Icons.PieChart className="w-5 h-5" />}
                                    {tab === 'students' && <Icons.GraduationCap className="w-5 h-5" />}
                                    {tab === 'history' && <Icons.History className="w-5 h-5" />}
                                    {tab === 'add' && <Icons.Plus className="w-5 h-5" />}
                                    {tab === 'settings' && <Icons.Building2 className="w-5 h-5" />}
                                    {tab}
                                </button>
                            ))}
                        </nav>
                        <div className="mt-auto pt-6 border-t dark:border-slate-700">
                            <p className="text-xs text-slate-400 mb-1">Status: {mode}</p>
                        </div>
                    </div>

                    {/* Mobile Bottom Navigation */}
                    <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 z-50 px-6 py-2 pb-safe-bottom flex justify-between items-center shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                        <button onClick={() => setActiveTab('dashboard')} className={`flex flex-col items-center gap-1 ${activeTab === 'dashboard' ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-400'}`}>
                            <Icons.PieChart className="w-6 h-6" />
                            <span className="text-[10px] font-medium">Home</span>
                        </button>
                        <button onClick={() => setActiveTab('students')} className={`flex flex-col items-center gap-1 ${activeTab === 'students' ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-400'}`}>
                            <Icons.GraduationCap className="w-6 h-6" />
                            <span className="text-[10px] font-medium">Students</span>
                        </button>
                        
                        <div className="relative -top-5">
                            <button onClick={() => setActiveTab('add')} className="w-14 h-14 bg-indigo-600 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-indigo-700 transition transform active:scale-95">
                                <Icons.Plus className="w-8 h-8" />
                            </button>
                        </div>

                        <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center gap-1 ${activeTab === 'history' ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-400'}`}>
                            <Icons.History className="w-6 h-6" />
                            <span className="text-[10px] font-medium">History</span>
                        </button>
                        <button onClick={() => setActiveTab('settings')} className={`flex flex-col items-center gap-1 ${activeTab === 'settings' ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-400'}`}>
                            <Icons.Building2 className="w-6 h-6" />
                            <span className="text-[10px] font-medium">Settings</span>
                        </button>
                    </div>

                    <div className="md:ml-64 min-h-screen flex flex-col pb-24 md:pb-0">
                        {/* Header - Desktop Only */}
                        <header className="hidden md:flex justify-between items-center p-8 bg-white dark:bg-slate-800 border-b border-slate-100 dark:border-slate-700 sticky top-0 z-10 shadow-sm">
                            <h2 className="text-2xl font-bold capitalize">{activeTab}</h2>
                            <div className="flex items-center gap-4">
                                <button onClick={() => setShowChartModal(true)} className="p-2 rounded-full bg-indigo-50 text-indigo-500 hover:bg-indigo-100 transition"><Icons.PieChart className="w-5 h-5" /></button>
                                <button onClick={fixCorruptedDataInternal} className="p-2 rounded-full bg-red-50 text-red-500 hover:bg-red-100 transition"><Icons.Tool className="w-5 h-5" /></button>
                                <button onClick={toggleDarkMode} className="p-2 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 transition hover:scale-110">{darkMode ? <Icons.Sun className="w-5 h-5" /> : <Icons.Moon className="w-5 h-5" />}</button>
                                <div className="text-right"><p className="text-xs text-slate-400 font-bold uppercase">Total Balance</p><p className={`text-3xl font-extrabold ${balanceColor}`}>â‚¹{summary.balance.toLocaleString()}</p></div>
                            </div>
                        </header>

                        {/* Header - Mobile Only */}
                        <header className="md:hidden bg-indigo-600 dark:bg-indigo-900 text-white pt-8 pb-10 px-6 rounded-b-[2rem] shadow-lg mb-6 sticky top-0 z-10">
                            <div className="flex justify-between items-center mb-4">
                                <div><h1 className="text-xl font-bold">My Wallet</h1><p className="text-indigo-200 text-xs">Mobile Manager</p></div>
                                <div className="flex gap-2">
                                    <button onClick={toggleDarkMode} className="p-2 rounded-full bg-white/20 backdrop-blur-sm active:bg-white/30 transition">{darkMode ? <Icons.Sun className="w-5 h-5" /> : <Icons.Moon className="w-5 h-5" />}</button>
                                </div>
                            </div>
                            <div className="text-center">
                                <p className="text-indigo-200 text-xs font-bold uppercase mb-1">Total Net Balance</p>
                                <h2 className="text-4xl font-extrabold tracking-tight">â‚¹{summary.balance.toLocaleString()}</h2>
                            </div>
                        </header>

                        <main className="flex-1 px-4 md:px-8 py-4 md:py-8 max-w-7xl mx-auto w-full">
                            {activeTab === 'dashboard' && (
                                <div className="space-y-6 animate-fade-in">
                                    {/* Loan Liability */}
                                    {summary.totalLoanPending > 0 && (
                                        <div className="bg-orange-50 dark:bg-orange-900/20 p-5 rounded-2xl border border-orange-100 dark:border-orange-800 shadow-sm cursor-pointer" onClick={() => setShowLoanDetails(!showLoanDetails)}>
                                            <div className="flex justify-between items-center">
                                                <div><p className="text-orange-600 font-bold text-xs uppercase">Active Loan Liability</p><p className="text-3xl font-bold text-orange-700">â‚¹{summary.totalLoanPending.toLocaleString()}</p></div>
                                                <div className="bg-orange-100 p-3 rounded-full text-orange-600">{showLoanDetails ? <Icons.ChevronUp /> : <Icons.ChevronDown />}</div>
                                            </div>
                                            {showLoanDetails && <div className="mt-4 pt-4 border-t border-orange-200 space-y-2">{loans.map(l => <div key={l.id} className="flex justify-between text-sm"><span className="font-bold">{l.name}</span><span className="text-orange-600">Pending: {l.total - l.paid}</span></div>)}</div>}
                                        </div>
                                    )}

                                    {/* Cash/Bank Cards - CLICKABLE */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {summary.cashGroup.map(acc => (
                                            <div key={acc.name} onClick={() => handleAccountFilter(acc.name)} className="bg-emerald-500 text-white p-5 rounded-2xl shadow-lg flex justify-between items-center cursor-pointer hover:opacity-90 transition"><div><p className="text-emerald-100 text-xs font-bold uppercase">Liquid Cash</p><p className="text-3xl font-bold">â‚¹{acc.amount.toLocaleString()}</p></div><div className="bg-white/20 p-3 rounded-full"><Icons.Banknote className="w-8 h-8 text-white" /></div></div>
                                        ))}
                                        {summary.bankGroup.map(acc => (
                                            <div key={acc.name} onClick={() => handleAccountFilter(acc.name)} className="bg-white dark:bg-slate-800 p-5 rounded-2xl border border-slate-100 shadow-sm flex justify-between items-center cursor-pointer hover:bg-slate-50 transition"><div><p className="text-slate-400 text-xs font-bold uppercase">{acc.name}</p><p className="text-2xl font-bold">â‚¹{acc.amount.toLocaleString()}</p></div><div className="bg-blue-50 p-3 rounded-xl text-blue-600"><Icons.Building2 className="w-6 h-6" /></div></div>
                                        ))}
                                    </div>

                                    {/* Credit Cards (Restored) - CLICKABLE */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {summary.creditGroup.map(acc => (
                                            <div key={acc.name} onClick={() => handleAccountFilter(acc.name)} className="bg-slate-800 text-white p-5 rounded-2xl shadow-lg flex justify-between items-center cursor-pointer hover:opacity-90 transition">
                                                <div><p className="text-slate-400 text-xs font-bold uppercase mb-1">{acc.name}</p><p className={`text-2xl font-bold ${acc.amount < 0 ? 'text-red-400' : 'text-white'}`}>â‚¹{acc.amount.toLocaleString()}</p></div>
                                                <div className="bg-white/10 p-3 rounded-full"><Icons.CreditCard className="w-8 h-8 text-white" /></div>
                                            </div>
                                        ))}
                                    </div>

                                    {/* Charts */}
                                    <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100">
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="font-bold flex items-center gap-2"><Icons.PieChart className="w-5 h-5 text-indigo-600" /> Analytics</h3>
                                            <button onClick={() => setChartView('overview')} className="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full">Reset</button>
                                        </div>
                                        {chartView === 'overview' && (
                                            <div className="flex flex-col md:flex-row items-center justify-around gap-8">
                                                <DonutChart income={summary.income} expense={summary.expense} onSliceClick={setChartView} />
                                                <div className="flex flex-col gap-4 w-full md:w-1/3">
                                                    <div className="flex items-center gap-3 p-3 rounded-xl bg-emerald-50 cursor-pointer" onClick={() => setChartView('income')}><div className="w-4 h-4 rounded-full bg-emerald-500"></div><div><p className="text-xs font-bold text-emerald-600 uppercase">Income</p><p className="text-lg font-bold text-slate-800">â‚¹{summary.income.toLocaleString()}</p></div></div>
                                                    <div className="flex items-center gap-3 p-3 rounded-xl bg-red-50 cursor-pointer" onClick={() => setChartView('expense')}><div className="w-4 h-4 rounded-full bg-red-400"></div><div><p className="text-xs font-bold text-red-500 uppercase">Expense</p><p className="text-lg font-bold text-slate-800">â‚¹{summary.expense.toLocaleString()}</p></div></div>
                                                </div>
                                            </div>
                                        )}
                                        {chartView === 'income' && <CategoryBarChart data={summary.incomeData} color="bg-emerald-500" onCategoryClick={setCategoryFilter} />}
                                        {chartView === 'expense' && <CategoryBarChart data={summary.expenseData} color="bg-red-400" onCategoryClick={setCategoryFilter} />}
                                    </div>
                                    
                                    {/* Transactions List */}
                                    <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                                        <div className="p-4 border-b border-slate-100 font-bold text-sm">Recent Transactions</div>
                                        <div className="divide-y divide-slate-100">
                                            {safeFilteredTransactions.slice(0, showAllTransactions ? undefined : 8).map(t => (
                                                <div key={t.id} className="flex justify-between items-center p-4 hover:bg-slate-50 dark:hover:bg-slate-700">
                                                    <div><p className="font-bold">{t.description}</p><p className="text-xs text-slate-500">{t.dateStr} â€¢ {t.category}</p></div>
                                                    <div className="flex items-center gap-2">
                                                        <p className={`font-bold ${t.type === 'income' ? 'text-emerald-500' : 'text-rose-500'}`}>{t.type === 'income' ? '+' : '-'} {t.amount}</p>
                                                        {/* EDIT & DELETE BUTTONS ADDED HERE */}
                                                        <button onClick={() => { setEditingTx(t); setAmount(t.amount); setDescription(t.description); setStudentName(t.studentName || ''); setFeeMonth(t.feeMonth || ''); if(t.feeMonth && t.feeMonth.includes(',')) setSelectedMonths(t.feeMonth.split(', ')); setType(t.type); setCategory(t.category); setPaymentMethod(t.paymentMethod); setDate(t.date); setActiveTab('add'); }} className="text-blue-400 hover:text-blue-600 p-1"><Icons.Pencil className="w-3 h-3" /></button>
                                                        <button onClick={() => handleDelete('transactions', t.id)} className="text-red-400 hover:text-red-600 p-1"><Icons.Trash2 className="w-3 h-3" /></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'add' && (
                                <div className="flex justify-center animate-fade-in">
                                    <div className="w-full max-w-lg bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-lg border border-slate-100 dark:border-slate-700">
                                        {editingTx && <div className="mb-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-xl flex justify-between items-center"><p className="text-sm text-yellow-800 dark:text-yellow-400 font-bold">âœï¸ Editing Transaction</p><button onClick={() => setEditingTx(null)} className="text-xs text-slate-500 dark:text-slate-300">Cancel</button></div>}
                                        
                                        {type === 'expense' && (
                                            <div className="mb-4">
                                                <div className="flex justify-between items-end mb-2"><label className="text-[10px] font-bold text-slate-400 uppercase block">Quick Expense</label><button onClick={() => setIsEditMode(!isEditMode)} className={`text-[10px] font-bold px-2 rounded ${isEditMode ? 'bg-red-500 text-white' : 'text-indigo-500 bg-indigo-50 dark:bg-indigo-900/30'}`}>{isEditMode ? 'Done' : 'Edit'}</button></div>
                                                <div className="grid grid-cols-2 md:grid-cols-3 gap-2">{expenseCategories.map(re => (
                                                    <div key={re.name} className="relative group">
                                                        <button type="button" onClick={() => handleQuickExpenseClick(re)} className={`w-full px-3 py-3 rounded-xl text-xs font-medium border transition flex flex-col items-center justify-center gap-1 ${category === re.name ? 'bg-rose-600 text-white border-rose-600 shadow-md' : 'bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300 border-slate-200 hover:bg-slate-100 dark:hover:bg-slate-600'}`}>
                                                            <span className="text-lg">{re.icon}</span> {re.name}
                                                        </button>
                                                        {isEditMode && (
                                                            <button onClick={(e) => { e.stopPropagation(); handleDeleteCategory(re.name); }} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] shadow-sm z-10 hover:bg-red-600 transition">
                                                                <Icons.X className="w-3 h-3" />
                                                            </button>
                                                        )}
                                                    </div>
                                                ))}<button type="button" onClick={handleAddCategory} className="px-3 py-3 rounded-xl text-xs font-bold border border-dashed border-slate-300 dark:border-slate-500 text-slate-400 dark:text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-700 transition flex flex-col items-center justify-center gap-1"><span className="text-lg">âž•</span> Add</button></div>
                                                {category === 'Loan/EMI' && (<div className="mt-3 p-3 bg-orange-50 dark:bg-orange-900/20 rounded-xl border border-orange-100 dark:border-orange-800 animate-fade-in"><label className="text-[10px] font-bold text-orange-500 uppercase block mb-1">Select Loan to Pay</label><select value={selectedLoanId} onChange={(e) => setSelectedLoanId(e.target.value)} className="w-full p-2 text-xs bg-white dark:bg-slate-700 rounded-lg border-none outline-none dark:text-white"><option value="">-- Select Loan --</option>{(loans || []).filter(l => l && l.name).map(l => <option key={l.id} value={l.id}>{l.name} (Bal: â‚¹{l.total - l.paid})</option>)}</select></div>)}
                                                {category === 'Credit Card Bill' && (<div className="mt-3 p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-xl border border-indigo-100 dark:border-indigo-800 animate-fade-in"><label className="text-[10px] font-bold text-indigo-500 uppercase block mb-1">Select Credit Card to Pay</label><select value={selectedCreditCard} onChange={(e) => setSelectedCreditCard(e.target.value)} className="w-full p-2 text-xs bg-white dark:bg-slate-700 rounded-lg border-none outline-none dark:text-white"><option value="">-- Select Card --</option>{summary.creditGroup.map(c => <option key={c.name} value={c.name}>{c.name} (Bal: â‚¹{c.amount})</option>)}</select></div>)}
                                            </div>
                                        )}

                                        <form onSubmit={handleTransactionSubmit} className="space-y-6">
                                            <div className="bg-slate-100 p-1 rounded-2xl flex">
                                                {['expense', 'income', 'transfer'].map(t => <button key={t} type="button" onClick={() => setType(t)} className={`flex-1 py-3 rounded-xl text-sm font-bold capitalize ${type === t ? 'bg-white shadow-sm' : 'text-slate-500'}`}>{t}</button>)}
                                            </div>
                                            
                                            {/* --- IMPROVED TRANSFER UI --- */}
                                            {type === 'transfer' ? (
                                                <div className="space-y-4 animate-fade-in">
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">From Account</label>
                                                        <select value={paymentMethod} onChange={(e) => setPaymentMethod(e.target.value)} className="w-full p-3 rounded-xl border bg-white dark:bg-slate-700 dark:text-white outline-none">
                                                            {ACCOUNTS.map(a => <option key={a} value={a}>{a}</option>)}
                                                        </select>
                                                    </div>
                                                    <div className="flex justify-center text-slate-400"><Icons.ArrowRight className="w-5 h-5 rotate-90" /></div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">To Account</label>
                                                        <select value={transferTo} onChange={(e) => setTransferTo(e.target.value)} className="w-full p-3 rounded-xl border bg-white dark:bg-slate-700 dark:text-white outline-none">
                                                            {ACCOUNTS.filter(a => a !== paymentMethod).map(a => <option key={a} value={a}>{a}</option>)}
                                                        </select>
                                                    </div>
                                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Description</label><input value={description} onChange={e => setDescription(e.target.value)} className="w-full p-4 rounded-xl border bg-slate-50 dark:bg-slate-800 dark:text-white" placeholder="Transfer Details..." /></div>
                                                </div>
                                            ) : (
                                                <>
                                                    {type === 'income' && <div><label className="text-xs font-bold text-slate-400 uppercase block mb-2">Source</label><div className="flex gap-2">{['Tuition Fees', 'Salary', 'Other'].map(c => <button key={c} type="button" onClick={() => setCategory(c)} className={`px-4 py-2 rounded-full text-xs font-bold border ${category === c ? 'bg-indigo-600 text-white' : ''}`}>{c}</button>)}</div></div>}
                                                    {category === 'Tuition Fees' && type === 'income' ? (
                                                        <div className="space-y-4">
                                                            <input list="student-list" value={studentName} onChange={e => setStudentName(e.target.value)} className="w-full p-3 rounded-xl border" placeholder="Student Name" />
                                                            <datalist id="student-list">{students.map(s => <option key={s.id} value={s.name} />)}</datalist>
                                                            <div>
                                                                <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Select Paying Months</label>
                                                                <div className="grid grid-cols-4 gap-2">
                                                                    {MONTHS.map(m => (
                                                                        <button 
                                                                            key={m} 
                                                                            type="button" 
                                                                            onClick={() => toggleMonth(m)}
                                                                            className={`text-[10px] py-2 px-1 rounded-lg border font-bold transition ${selectedMonths.includes(m) ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50 dark:bg-slate-700 dark:text-white'}`}
                                                                        >
                                                                            {m.substring(0, 3)}
                                                                        </button>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ) : type !== 'transfer' && <input value={description} onChange={e => setDescription(e.target.value)} className="w-full p-4 rounded-2xl border bg-slate-50" placeholder="Description" />}
                                                </>
                                            )}

                                            <div className="grid grid-cols-2 gap-4"><input type="number" value={amount} onChange={e => setAmount(e.target.value)} className="w-full p-4 rounded-2xl border font-bold text-lg" placeholder="0.00" /><input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full p-4 rounded-2xl border" /></div>
                                            
                                            {/* Hide Payment Method grid for Transfers as it uses dropdowns now */}
                                            {type !== 'transfer' && (
                                                <div className="grid grid-cols-3 gap-2">
                                                    {ACCOUNTS.map(m => <button key={m} type="button" onClick={() => setPaymentMethod(m)} className={`py-3 px-2 rounded-xl text-[10px] font-bold flex flex-col items-center gap-1 border ${paymentMethod === m ? 'bg-indigo-600 text-white' : 'bg-white'}`}><PaymentIcon method={m} /> {m}</button>)}
                                                </div>
                                            )}
                                            
                                            <button type="submit" className="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold text-lg shadow-lg">Save Transaction</button>
                                        </form>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'students' && (
                                <div className="space-y-6 animate-fade-in">
                                    {/* Stats Summary Filters */}
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div onClick={() => setStudentFilterType('all')} className={`p-5 rounded-2xl text-center shadow-sm border filter-card ${studentFilterType === 'all' ? 'active' : 'bg-indigo-50 border-indigo-100 dark:bg-indigo-900/30 dark:border-indigo-800'}`}><p className="text-xs text-indigo-600 dark:text-indigo-300 font-bold tracking-widest uppercase mb-1">Total Students</p><p className="text-3xl font-extrabold text-indigo-900 dark:text-white">{tStats.totalStudents}</p></div>
                                        <div onClick={() => setStudentFilterType('received')} className={`p-5 rounded-2xl text-center shadow-sm border filter-card ${studentFilterType === 'received' ? 'active' : 'bg-emerald-50 border-emerald-100 dark:bg-emerald-900/30 dark:border-emerald-800'}`}><p className="text-xs text-emerald-600 dark:text-emerald-300 font-bold tracking-widest uppercase mb-1">Total Received</p><p className="text-3xl font-extrabold text-emerald-900 dark:text-white">â‚¹{tStats.totalReceived.toLocaleString()}</p></div>
                                        <div onClick={() => setStudentFilterType('pending')} className={`p-5 rounded-2xl text-center shadow-sm border filter-card ${studentFilterType === 'pending' ? 'active' : 'bg-rose-50 border-rose-100 dark:bg-rose-900/30 dark:border-rose-800'}`}><p className="text-xs text-rose-600 dark:text-rose-300 font-bold tracking-widest uppercase mb-1">Total Pending</p><p className="text-3xl font-extrabold text-rose-900 dark:text-white">â‚¹{tStats.totalPending.toLocaleString()}</p></div>
                                    </div>

                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                        <div className="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                                            <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg text-slate-700 dark:text-slate-200">Student Directory</h3><div className="flex gap-2"><button onClick={() => { setEditingStudent(null); setStudentName(''); setStudentParent(''); setStudentFee(''); setStudentJoinDate(''); setStudentLeaveDate(''); setStudentPhone(''); }} className="text-xs bg-indigo-50 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-300 px-3 py-1 rounded-lg font-bold hover:bg-indigo-100">Add New</button></div></div>
                                            
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                {(students || []).filter(s => { if (studentFilterType === 'all') return true; const fin = getStudentFinancials(s); if (studentFilterType === 'pending') return fin.pending > 0; if (studentFilterType === 'received') return fin.status === 'Paid' || fin.status === 'Advance'; return true; })
                                                    .map((student) => {
                                                    const fin = getStudentFinancials(student);
                                                    let statusColor = 'text-gray-500'; if(fin.status === 'Overdue') statusColor = 'text-red-600 dark:text-red-400'; if(fin.status === 'Due') statusColor = 'text-orange-500 dark:text-orange-400'; if(fin.status === 'Paid') statusColor = 'text-emerald-600 dark:text-emerald-400'; if(fin.status === 'Advance') statusColor = 'text-blue-600 dark:text-blue-400';

                                                    return (
                                                        <div key={student.id} onClick={(e) => { if(!e.target.closest('button')) setViewingStudent(student) }} className="bg-white dark:bg-slate-700 border border-slate-100 dark:border-slate-600 p-4 rounded-xl hover:shadow-md transition cursor-pointer relative group">
                                                            <div className="flex justify-between items-start mb-2"><div className="flex items-center gap-2"><div className="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 flex items-center justify-center font-bold text-xs">{student.name ? student.name.charAt(0) : '?'}</div><div><p className="font-bold text-slate-800 dark:text-white text-sm">{student.name}</p><p className="text-[10px] text-slate-500 dark:text-slate-400">{student.parentName && `Parent: ${student.parentName}`}</p></div></div><div className="flex gap-1 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={(e) => { e.stopPropagation(); setEditingStudent(student); setStudentName(student.name); setStudentParent(student.parentName); setStudentFee(student.monthlyFee); setStudentJoinDate(student.joinDate); setStudentPhone(student.phone); setStudentSchool(student.school || ''); setStudentBoard(student.board || BOARDS[0]); setStudentStd(student.std || STANDARDS[0]); setStudentMedium(student.medium || MEDIUMS[0]); setStudentLeaveDate(student.leaveDate || ''); }} className="text-blue-400 hover:text-blue-600 p-1"><Icons.Pencil className="w-3 h-3" /></button><button onClick={(e) => { e.stopPropagation(); handleDelete('students', student.id); }} className="text-red-300 hover:text-red-500 p-1"><Icons.Trash2 className="w-3 h-3" /></button></div></div>
                                                            <div className="mt-2 pt-2 border-t border-slate-50 dark:border-slate-600 flex justify-between items-end"><div>{fin.pending > 0 && fin.missingMonths.length > 0 ? (<p className="text-xs font-bold text-red-600 dark:text-red-400 mb-1">ðŸ”´ {fin.missingMonths.length} Months Due</p>) : (<p className={`text-xs font-bold ${statusColor} mb-1`}>{fin.status}</p>)}<p className="text-[10px] text-slate-400">Fee: â‚¹{student.monthlyFee}/mo</p></div><div className="flex gap-1">{fin.pending > 0 && <button onClick={(e) => { e.stopPropagation(); sendReminder(student, fin.pending, fin.missingMonths); }} className="bg-green-50 dark:bg-green-900/30 text-green-600 p-2 rounded-lg"><Icons.MessageCircle className="w-4 h-4" /></button>}</div></div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                        
                                        {/* Right Column: Add/Edit Form */}
                                        <div className="lg:col-span-1">
                                            <div id="student-form" className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 sticky top-6">
                                                <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg text-slate-700 dark:text-slate-200">{editingStudent ? 'Edit Student' : 'Register Student'}</h3>{editingStudent && <button onClick={handleCancelStudentEdit} className="text-xs text-slate-500 underline">Cancel</button>}</div>
                                                <form onSubmit={handleStudentSubmit} className="flex flex-col gap-4">
                                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Name</label><input type="text" value={studentName} onChange={e => setStudentName(e.target.value)} className="w-full p-3 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl border-none outline-none" required /></div>
                                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Parent Name</label><input type="text" value={studentParent} onChange={e => setStudentParent(e.target.value)} className="w-full p-3 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl border-none outline-none" /></div>
                                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">WhatsApp</label><input type="tel" value={studentPhone} onChange={e => setStudentPhone(e.target.value)} className="w-full p-3 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl border-none outline-none" /></div>
                                                    
                                                    {/* RESTORED FIELDS */}
                                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">School</label><input type="text" list="school-list" value={studentSchool} onChange={e => setStudentSchool(e.target.value)} className="w-full p-3 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl border-none outline-none" />
                                                        <datalist id="school-list">{(uniqueSchools).map(s => <option key={s} value={s} />)}</datalist>
                                                    </div>
                                                    
                                                    <div className="grid grid-cols-3 gap-2">
                                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Std</label><select value={studentStd} onChange={e => setStudentStd(e.target.value)} className="w-full p-2 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-lg border-none text-xs outline-none">{STANDARDS.map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Medium</label><select value={studentMedium} onChange={e => setStudentMedium(e.target.value)} className="w-full p-2 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-lg border-none text-xs outline-none">{MEDIUMS.map(m => <option key={m} value={m}>{m}</option>)}</select></div>
                                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Board</label><select value={studentBoard} onChange={e => setStudentBoard(e.target.value)} className="w-full p-2 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-lg border-none text-xs outline-none">{BOARDS.map(b => <option key={b} value={b}>{b}</option>)}</select></div>
                                                    </div>

                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Fee</label><input type="number" value={studentFee} onChange={e => setStudentFee(e.target.value)} className="w-full p-3 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl border-none outline-none" required /></div>
                                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Joined</label><input type="date" value={studentJoinDate} onChange={e => setStudentJoinDate(e.target.value)} className="w-full p-3 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl border-none outline-none" required /></div>
                                                    </div>
                                                    <div><label className="text-[10px] font-bold text-red-400 uppercase mb-1 block">Leaving Date</label><input type="date" value={studentLeaveDate} onChange={e => setStudentLeaveDate(e.target.value)} className="w-full p-3 bg-red-50 dark:bg-red-900/20 dark:text-white rounded-xl border-none outline-none" /></div>
                                                    <div className="flex gap-2">
                                                        <button type="submit" className="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold">{editingStudent ? 'Update' : 'Add'}</button>
                                                        {editingStudent && <button type="button" onClick={handleCancelStudentEdit} className="px-4 bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 rounded-xl font-bold">Cancel</button>}
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* FAB FOR ADDING STUDENTS (Mobile Only) */}
                                    <div className="md:hidden fab" onClick={scrollToForm}>
                                        <Icons.Plus className="w-6 h-6" />
                                    </div>
                                </div>
                            )}

                            {activeTab === 'history' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col md:flex-row gap-4 items-center justify-between">
                                        <div className="flex items-center gap-2 w-full md:w-auto"><Icons.Calendar className="w-4 h-4 text-slate-400" /><input type="date" value={dateFilter.start} onChange={e => setDateFilter({...dateFilter, start: e.target.value})} className="bg-slate-50 dark:bg-slate-700 text-xs p-2 rounded-lg border-none outline-none dark:text-white flex-1" /><span className="text-slate-400 text-xs">to</span><input type="date" value={dateFilter.end} onChange={e => setDateFilter({...dateFilter, end: e.target.value})} className="bg-slate-50 dark:bg-slate-700 text-xs p-2 rounded-lg border-none outline-none dark:text-white flex-1" />{(dateFilter.start || dateFilter.end) && <button onClick={() => setDateFilter({start:'', end:''})} className="text-xs text-red-400 hover:text-red-600 px-2">Clear</button>}</div>
                                        <div className="flex gap-2 w-full md:w-auto">
                                            {accountFilter !== 'All' && <div className="bg-indigo-100 text-indigo-700 text-xs px-3 py-2 rounded-lg font-bold flex items-center gap-2">Filter: {accountFilter} <button onClick={() => setAccountFilter('All')}><Icons.X className="w-3 h-3" /></button></div>}
                                            <button onClick={handleFilteredExport} className="flex items-center gap-2 bg-green-50 dark:bg-green-900/30 text-green-600 px-3 py-2 rounded-lg text-xs font-bold hover:bg-green-100 transition justify-center flex-1"><Icons.Download className="w-4 h-4" /> Export</button>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-3 gap-2 md:gap-4">
                                        <div className="bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700 text-center"><p className="text-[10px] font-bold text-slate-400 uppercase">Income</p><p className="text-sm md:text-lg font-bold text-emerald-500">â‚¹{safeFilteredTransactions.filter(t => t.type === 'income').reduce((acc, t) => acc + parseFloat(t.amount), 0).toLocaleString()}</p></div>
                                        <div className="bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700 text-center"><p className="text-[10px] font-bold text-slate-400 uppercase">Expense</p><p className="text-sm md:text-lg font-bold text-red-500">â‚¹{safeFilteredTransactions.filter(t => t.type === 'expense').reduce((acc, t) => acc + parseFloat(t.amount), 0).toLocaleString()}</p></div>
                                        <div className="bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700 text-center"><p className="text-[10px] font-bold text-slate-400 uppercase">Net</p><p className="text-sm md:text-lg font-bold text-indigo-500">â‚¹{(safeFilteredTransactions.filter(t => t.type === 'income').reduce((acc, t) => acc + parseFloat(t.amount), 0) - safeFilteredTransactions.filter(t => t.type === 'expense').reduce((acc, t) => acc + parseFloat(t.amount), 0)).toLocaleString()}</p></div>
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                                        <div className="p-4 border-b border-slate-100 dark:border-slate-700 font-bold text-sm text-slate-700 dark:text-slate-200">Transaction History ({safeFilteredTransactions.length})</div>
                                        <div className="divide-y divide-slate-100 dark:divide-slate-700">{safeFilteredTransactions.length > 0 ? safeFilteredTransactions.map((t) => (<div key={t.id} className="flex items-center justify-between p-3 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition"><div className="flex items-center gap-3 overflow-hidden"><div className={`flex-shrink-0 p-2 rounded-full ${t.category === 'Tuition Fees' ? 'bg-indigo-100 dark:bg-indigo-900' : (t.type === 'income' ? 'bg-emerald-100 dark:bg-emerald-900' : 'bg-rose-100 dark:bg-rose-900')}`}>{t.category === 'Tuition Fees' ? <Icons.GraduationCap className="w-4 h-4 text-indigo-600 dark:text-indigo-300" /> : (t.type === 'income' ? <Icons.TrendingUp className="w-4 h-4 text-emerald-600 dark:text-emerald-300" /> : <Icons.TrendingDown className="w-4 h-4 text-rose-600 dark:text-rose-300" />)}</div><div className="min-w-0"><p className="font-semibold text-slate-800 dark:text-slate-200 text-sm truncate">{t.studentName || t.description}</p><p className="text-xs text-slate-500">{t.dateStr} â€¢ {t.category}</p></div></div><div className="flex items-center gap-3 ml-2 flex-shrink-0"><div className="text-right"><p className={`font-bold text-sm ${t.type === 'income' ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-600 dark:text-rose-400'}`}>{t.type === 'income' ? '+' : '-'} â‚¹{t.amount.toLocaleString()}</p><button onClick={() => { setEditingTx(t); setAmount(t.amount); setDescription(t.description); setStudentName(t.studentName || ''); setFeeMonth(t.feeMonth || ''); if(t.feeMonth && t.feeMonth.includes(',')) setSelectedMonths(t.feeMonth.split(', ')); setType(t.type); setCategory(t.category); setPaymentMethod(t.paymentMethod); setDate(t.date); setActiveTab('add'); }} className="text-blue-400 hover:text-blue-600 p-1"><Icons.Pencil className="w-3 h-3" /></button><button onClick={() => handleDelete('transactions', t.id)} className="text-red-400 hover:text-red-600 p-1"><Icons.Trash2 className="w-3 h-3" /></button></div></div></div>)) : (<div className="p-8 text-center text-slate-400 text-sm">No transactions found for this period.</div>)}</div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'settings' && (
                                <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 space-y-6 max-w-2xl mx-auto animate-fade-in">
                                    <div className="p-5 bg-slate-50 dark:bg-slate-700/50 rounded-2xl border border-slate-200 dark:border-slate-600"><h3 className="font-bold text-slate-900 dark:text-white mb-3">Opening Balances</h3><div className="space-y-2">{ACCOUNTS.map(acc => (<div key={acc} className="flex justify-between items-center text-sm"><span className="text-slate-600 dark:text-slate-300">{acc}</span><input type="number" placeholder="0" value={openingBalances[acc] || ''} onChange={(e) => { const val = parseFloat(e.target.value); setOpeningBalances({...openingBalances, [acc]: val}); if(mode==='local') saveLocalData(null, null, null, {...openingBalances, [acc]: val}); }} className="w-24 p-1 bg-white dark:bg-slate-600 border rounded text-right dark:text-white" /></div>))}</div><p className="text-[10px] text-slate-400 mt-2">* Enter negative amount (e.g. -50000) for credit card debt.</p></div>
                                    
                                    <div className="p-5 bg-orange-50 dark:bg-orange-900/20 rounded-2xl border border-orange-100 dark:border-orange-800"><div className="flex justify-between items-center mb-3"><h3 className="font-bold text-orange-900 dark:text-orange-200">Active Loans</h3><button onClick={() => setShowLoanForm(!showLoanForm)} className="text-xs bg-orange-200 text-orange-800 px-2 py-1 rounded hover:bg-orange-300">Add Loan</button></div>{showLoanForm && (<div className="mb-4 p-3 bg-white dark:bg-slate-700 rounded-xl space-y-2 animate-fade-in"><input type="text" placeholder="Loan Name (e.g. Car Loan)" value={newLoan.name} onChange={(e) => setNewLoan({...newLoan, name: e.target.value})} className="w-full p-2 text-xs border rounded" /><input type="number" placeholder="Total Principal Amount" value={newLoan.total} onChange={(e) => setNewLoan({...newLoan, total: e.target.value})} className="w-full p-2 text-xs border rounded" /><button onClick={handleAddLoan} className="w-full bg-orange-600 text-white py-2 rounded text-xs font-bold">Save Loan</button></div>)}<div className="space-y-2">{(loans || []).filter(l => l && l.name).map(l => (<div key={l.id} className="flex justify-between items-center text-xs p-2 bg-white dark:bg-slate-700 rounded-lg"><div><p className="font-bold dark:text-white">{l.name}</p><p className="text-slate-400">Paid: {l.paid} / {l.total}</p></div><div className="flex gap-2"><button onClick={() => handleUpdateLoanBalance(l.id, prompt("Correct Paid Amount:", l.paid))} className="text-blue-500 underline">Edit</button><button onClick={() => handleDelete('loans', l.id)} className="text-red-500">Delete</button></div></div>))}{(loans || []).length === 0 && <p className="text-center text-xs text-orange-400">No active loans.</p>}</div></div>
                                    
                                    <div className="p-5 bg-indigo-50 dark:bg-indigo-900/20 rounded-2xl border border-indigo-100 dark:border-indigo-800"><div className="flex items-center gap-3 mb-3"><div className="p-2 bg-white dark:bg-indigo-900 rounded-lg text-indigo-600 dark:text-indigo-400"><Icons.MessageSquare className="w-5 h-5" /></div><h3 className="font-bold text-indigo-900 dark:text-indigo-200">Reminder Template</h3></div><textarea rows="4" value={reminderMsg} onChange={e => setReminderMsg(e.target.value)} className="w-full p-3 text-xs border border-indigo-200 dark:border-indigo-700 rounded-xl mb-3 focus:ring-2 focus:ring-indigo-500 outline-none dark:bg-slate-700 dark:text-white"></textarea><div className="flex justify-between items-center"><p className="text-[10px] text-indigo-400">Placeholders: {'{name}'}, {'{amount}'}, {'{months}'}</p><button onClick={() => { localStorage.setItem('my_wallet_msg', reminderMsg); alert("Saved!"); }} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-indigo-700 transition">Save Template</button></div></div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="p-5 bg-blue-50 dark:bg-blue-900/20 rounded-2xl border border-blue-100 dark:border-blue-800"><div className="flex items-center gap-3 mb-3"><div className="p-2 bg-white dark:bg-blue-900 rounded-lg text-blue-600 dark:text-blue-400"><Icons.Share className="w-5 h-5" /></div><h3 className="font-bold text-blue-900 dark:text-blue-200">Backup</h3></div><button onClick={handleBackup} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-sm shadow-sm flex items-center justify-center gap-2 hover:bg-blue-700 transition"><Icons.Upload className="w-4 h-4" /> Backup to Drive</button></div><div className="p-5 bg-slate-50 dark:bg-slate-700/50 rounded-2xl border border-slate-200 dark:border-slate-600"><div className="flex items-center gap-3 mb-3"><div className="p-2 bg-white dark:bg-slate-600 rounded-lg text-slate-600 dark:text-slate-300"><Icons.Download className="w-5 h-5" /></div><h3 className="font-bold text-slate-900 dark:text-white">Restore</h3></div><div className="relative"><input type="file" accept=".json" onChange={handleImport} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" /><button className="w-full bg-white dark:bg-slate-600 border-2 border-slate-200 dark:border-slate-500 text-slate-600 dark:text-white py-3 rounded-xl font-bold text-sm hover:bg-slate-100 dark:hover:bg-slate-500 transition flex items-center justify-center gap-2"><Icons.Upload className="w-4 h-4" /> Select File</button></div></div></div>
                                    
                                    <div className="p-5 bg-red-50 rounded-2xl border border-red-100 mt-8"><div className="flex items-center gap-2 mb-3"><Icons.Tool className="w-5 h-5 text-red-500" /><h3 className="font-bold text-red-800">Troubleshoot</h3></div><div className="space-y-2"><button onClick={fixCorruptedDataInternal} className="w-full bg-white text-red-600 border border-red-200 py-2 rounded-xl font-bold text-xs shadow-sm hover:bg-red-50">Fix Corrupted Data</button><button onClick={() => { if(confirm('WARNING: This will delete ALL locally saved data. Do you want to proceed?')) { localStorage.clear(); window.location.reload(); } }} className="w-full bg-red-600 text-white border border-red-600 py-2 rounded-xl font-bold text-xs shadow-sm hover:bg-red-700">Factory Reset</button></div></div>
                                </div>
                            )}
                        </main>
                    </div>

                    {/* Student Detail Modal */}
                    {viewingStudent && (
                        <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 animate-fade-in" onClick={() => setViewingStudent(null)}>
                            <div className="bg-white dark:bg-slate-800 w-full max-w-lg rounded-3xl overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                                <div className="bg-indigo-600 p-6 text-white relative">
                                    <button onClick={() => setViewingStudent(null)} className="absolute top-4 right-4 bg-white/20 p-2 rounded-full hover:bg-white/30"><Icons.X className="w-5 h-5" /></button>
                                    <h2 className="text-2xl font-bold">{viewingStudent.name}</h2>
                                    <p className="text-indigo-200">{viewingStudent.std} â€¢ {viewingStudent.school}</p>
                                    <div className="mt-2 text-xs opacity-90 flex gap-2">
                                        <span className="bg-white/20 px-2 py-1 rounded">{viewingStudent.medium} Med.</span>
                                        <span className="bg-white/20 px-2 py-1 rounded">{viewingStudent.board}</span>
                                    </div>
                                </div>
                                <div className="p-6 max-h-[70vh] overflow-y-auto">
                                    <div className="grid grid-cols-2 gap-4 mb-6 text-sm">
                                        <div className="p-3 bg-slate-50 dark:bg-slate-700 rounded-xl"><p className="text-[10px] uppercase text-slate-400 font-bold">Parent</p><p className="font-bold dark:text-white">{viewingStudent.parentName || '-'}</p></div>
                                        <div className="p-3 bg-slate-50 dark:bg-slate-700 rounded-xl"><p className="text-[10px] uppercase text-slate-400 font-bold">Phone</p><p className="font-bold dark:text-white">{viewingStudent.phone || '-'}</p></div>
                                        <div className="p-3 bg-slate-50 dark:bg-slate-700 rounded-xl"><p className="text-[10px] uppercase text-slate-400 font-bold">Joined</p><p className="font-bold dark:text-white">{viewingStudent.joinDate || '-'}</p></div>
                                        <div className="p-3 bg-slate-50 dark:bg-slate-700 rounded-xl"><p className="text-[10px] uppercase text-slate-400 font-bold">Left</p><p className="font-bold dark:text-white">{viewingStudent.leaveDate || '-'}</p></div>
                                    </div>

                                    {/* PRO-RATA CALCULATION */}
                                    <div className="p-4 bg-blue-50 dark:bg-blue-900/30 rounded-xl border border-blue-100 dark:border-blue-800 mb-6">
                                        <h4 className="font-bold text-blue-800 dark:text-blue-200 text-sm mb-2">First Month Pro-Rata Fee</h4>
                                        <div className="flex justify-between items-center text-sm">
                                            <span className="text-blue-600 dark:text-blue-300">Daily Rate: â‚¹{Math.round(viewingStudent.monthlyFee/30)}</span>
                                            <span className="font-bold text-blue-900 dark:text-white text-lg">â‚¹{calculateProRata(viewingStudent.monthlyFee, viewingStudent.joinDate)}</span>
                                        </div>
                                    </div>

                                    <div className="mb-6">
                                        <h4 className="font-bold text-slate-700 dark:text-slate-200 mb-2">Financial Status</h4>
                                        {(() => {
                                            const fin = getStudentFinancials(viewingStudent);
                                            return (
                                                <div className={`p-4 rounded-xl border ${fin.pending > 0 ? 'bg-red-50 border-red-100 dark:bg-red-900/20' : 'bg-emerald-50 border-emerald-100 dark:bg-emerald-900/20'}`}>
                                                    <div className="flex justify-between mb-2"><span className="text-sm text-slate-500 dark:text-slate-400">Status</span><span className={`text-sm font-bold ${fin.pending > 0 ? 'text-red-600' : 'text-emerald-600'}`}>{fin.status}</span></div>
                                                    <div className="flex justify-between"><span className="text-sm text-slate-500 dark:text-slate-400">Pending Amount</span><span className={`text-lg font-bold ${fin.pending > 0 ? 'text-red-600' : 'text-emerald-600'}`}>â‚¹{fin.pending}</span></div>
                                                    {fin.missingMonths.length > 0 && <p className="mt-2 text-xs text-red-500 font-medium">Due: {fin.missingMonths.join(', ')}</p>}
                                                </div>
                                            )
                                        })()}
                                    </div>

                                    <div className="grid grid-cols-3 gap-2">
                                        <button onClick={() => { setStudentName(viewingStudent.name); setCategory('Tuition Fees'); setType('income'); setAmount(viewingStudent.monthlyFee); setFeeMonth(MONTHS[new Date().getMonth()]); setViewingStudent(null); setActiveTab('add'); }} className="bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg text-sm">Pay Fee</button>
                                        <button onClick={() => { const fin = getStudentFinancials(viewingStudent); sendReminder(viewingStudent, fin.pending, fin.missingMonths); }} className="bg-green-50 text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 text-sm"><Icons.MessageCircle className="w-4 h-4" /> Remind</button>
                                        <button onClick={handleEditStudentFromModal} className="bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-white rounded-xl font-bold shadow-lg text-sm">Edit Profile</button>
                                    </div>
                                    
                                    <div className="mt-6">
                                        <h4 className="font-bold text-slate-700 dark:text-slate-200 mb-3 text-sm">Payment History</h4>
                                        <div className="space-y-2">
                                            {transactions.filter(t => t.studentName === viewingStudent.name && t.category === 'Tuition Fees').map(tx => (
                                                <div key={tx.id} className="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-700 rounded-lg text-sm">
                                                    <div><p className="font-bold dark:text-white">â‚¹{tx.amount}</p><p className="text-xs text-slate-500">{tx.feeMonth} â€¢ {tx.dateStr}</p></div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => sendReceiptWhatsApp(tx, viewingStudent)} className="text-green-500 hover:text-green-700"><Icons.Share className="w-4 h-4" /></button>
                                                        <button onClick={() => generatePDFReceipt(tx)} className="text-indigo-500 hover:text-indigo-700"><Icons.Download className="w-4 h-4" /></button>
                                                    </div>
                                                </div>
                                            ))}
                                            {transactions.filter(t => t.studentName === viewingStudent.name && t.category === 'Tuition Fees').length === 0 && <p className="text-xs text-slate-400 text-center">No history.</p>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>